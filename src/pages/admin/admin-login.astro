---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Admin - Login" description="Acceso al panel de administración">
  <div class="min-h-screen bg-gradient-to-br from-amber-900 to-gray-900 flex items-center justify-center px-4">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-serif font-bold text-gray-900">Galiana</h1>
        <p class="text-gray-600 mt-2">Panel de Administración</p>
      </div>

      <form class="space-y-6" id="login-form">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
            Correo Electrónico
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-amber-900"
            placeholder="admin@galiana.com"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
            Contraseña
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-amber-900"
            placeholder="••••••••"
          />
        </div>

        <button
          type="submit"
          class="w-full bg-amber-900 text-white py-2 rounded-lg font-medium hover:bg-amber-800 transition-colors"
          id="btn-submit"
        >
          Ingresar
        </button>
      </form>

      <div id="message" class="mt-4 text-center"></div>
    </div>
  </div>

  <script is:inline>
    const form = document.getElementById('login-form');
    const messageDiv = document.getElementById('message');
    const btnSubmit = document.getElementById('btn-submit');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;

      btnSubmit.disabled = true;
      btnSubmit.textContent = 'Cargando...';

      try {
        // Esperar a que Supabase esté disponible
        let intentos = 0;
        while (!window.supabaseClient && intentos < 30) {
          await new Promise(resolve => setTimeout(resolve, 100));
          intentos++;
        }

        if (!window.supabaseClient) {
          throw new Error('No se pudo conectar al servidor');
        }

        const supabase = window.supabaseClient;

        // Autenticar con Supabase
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          throw new Error(error.message);
        }

        if (data.session) {
          // Verificar si es admin
          const { data: roleData, error: roleError } = await supabase
            .from('user_roles')
            .select('role')
            .eq('user_id', data.session.user.id)
            .single();

          if (roleError || !roleData || roleData.role !== 'admin') {
            // Cerrar sesión si no es admin
            await supabase.auth.signOut();
            throw new Error('No tienes permisos para acceder al panel de administración');
          }

          // Guardar la sesión
          localStorage.setItem('adminSession', JSON.stringify(data.session));
          
          // Redirigir al panel admin
          window.location.href = '/admin';
        }
      } catch (err) {
        messageDiv.innerHTML = `<p class="text-red-600">${err.message || 'Error al iniciar sesión'}</p>`;
        btnSubmit.disabled = false;
        btnSubmit.textContent = 'Ingresar';
      }
    });
  </script>
</BaseLayout>
